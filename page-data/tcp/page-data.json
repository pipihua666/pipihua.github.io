{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/tcp","result":{"data":{"post":{"id":"544ca156-d750-5f5b-ab90-326ad1bfb1ad","headings":[{"depth":2},{"depth":2},{"depth":2}],"frontmatter":{"title":"TCP服务端和浏览器端的三次握手和四次分手","path":"/tcp","tags":["Network"],"excerpt":"TCP服务端和浏览器端的三次握手和四次分手","created":"2021-02-20 21:45","createdPretty":"20 February, 2021","updated":"2021-04-11T00:00:00.000Z","updatedPretty":"11 April, 2021","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsTAAALEwEAmpwYAAADAklEQVQoz1WP+09SARTH75/QDJTHBS4CCqbRsMyl5tSpKx9Np8upG2u1sjRTm25qbm31g2W6NjVL1NRIS803yHyCgMC9PC9wQbhwUURt1S/92i9drR/qu8/OznbO+Z5zgO6u7oG+gY8jo/OTn1Szc1sK5fbahn5LC++YtBo9bLLABsSGWO0w4oBhsxHR62H1tkG1qVOua4DO3nevh8dlk1+mF1eUa2qN1miEzXaH02Aw5eflZqRdqa6s9GJeL4aR+N0un9OB2a0oYrIZdUDPqHxwZn5iZW1BrV81mjVWVG93uolwv2yEwWDer60TikSzS4pgOOLa9bt9uNvrd3o8VhSFbRZAPj2xoFre0G7pEANst1idDpsLDUXCjxobmCDY1d0tEAgKi4uIvRAeDOAB3B/w+3CfZxdzeRzAouKzRqtCzFoUNbkxG+ZBSfYPiJaWxxQKhclgUKnUioqbBwehIOEjQj6C8AUJbzCIBfwOYH5ueHN9xqBTWJENh23b4zZ5MOQo4pN/GKLR6HwBn0KhdnY++/E9HMRdewS2R7j3gs4Qbid2YUA91G78/Mo832dbGnQoR3DN5L5hJmJR3CjIi46O4fN4ZynUpod3fxJwxKM9wuEj3HiM7xwHdId+NWAcaXROPUXnXvhVvcSWDFuVEZrxrtaaGBodgqBYLjeKEt14u/zXruKbeeqrZTpskId170PbstBmP/BWmjVTW7DUUKJorlhrlyrb7jyXltEYTDabDZ2KzOvKS+TtTWOt9csdta6X9XhP3eGb2v2xOiA9SVKYkirNya7Ozb91vaChrCzrooTOBLkQxOFwhPEiFpuVLrlUlZsvzc6syb3aXJTdUZrzpDTnXtk1QJiYHJdwgSc6zxOJecIkbvw5kAOdDEJcfpwwq7iSw2GLUzMziqtimCCVAUbRmGdi6FF0EIoXA2yyyCbdScA/kAvJaZDJkFzOqHjQJkxIShQnS1LSOCwWF+KSF8VCEBnJToDzV9A/nIj8mS+ITxInk/0sFsg6Nf1PEPQb/LmEKWGS80AAAAAASUVORK5CYII=","aspectRatio":1.6,"src":"/static/f1c2b97eb13574766d32aacd28ee9c75/90823/couple.png","srcSet":"/static/f1c2b97eb13574766d32aacd28ee9c75/dc47e/couple.png 200w,\n/static/f1c2b97eb13574766d32aacd28ee9c75/9f2d5/couple.png 400w,\n/static/f1c2b97eb13574766d32aacd28ee9c75/90823/couple.png 800w,\n/static/f1c2b97eb13574766d32aacd28ee9c75/77647/couple.png 1200w,\n/static/f1c2b97eb13574766d32aacd28ee9c75/f8d4f/couple.png 1600w,\n/static/f1c2b97eb13574766d32aacd28ee9c75/4ce6a/couple.png 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1031px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b51daad90009cb69b9edc04b133994d/23592/tcp.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlklEQVQY042QSw4DIQxDuf9Zp6IzfJMw0KemYtFFVWEEcbBjEe55/4kuvbbqKLW03gI7PuNcC/wW55Jt2LgHdzWlDGzErdeUk5jup3NNx2aYRsn78zq5UAbCcIjJ8ThEFRZvgLewTL0ELiYzevcKn5kq+G0BgIxnTDnrMGeudH3H5sAMyhve89iLj5i6k78/rDAQoET1AsSWX4lcrCKoAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp\"\n        title=\"tcp\"\n        src=\"/static/6b51daad90009cb69b9edc04b133994d/23592/tcp.png\"\n        srcset=\"/static/6b51daad90009cb69b9edc04b133994d/5a46d/tcp.png 300w,\n/static/6b51daad90009cb69b9edc04b133994d/0a47e/tcp.png 600w,\n/static/6b51daad90009cb69b9edc04b133994d/23592/tcp.png 1031w\"\n        sizes=\"(max-width: 1031px) 100vw, 1031px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>有图可知，由于 HTTP 只有请求和响应的概念，信道连接需要通过 TCP 来完成的，因此让我们先来谈谈 TCP 的三次握手和四次分手吧</p>\n</blockquote>\n<h2 id=\"三次握手\" style=\"position:relative;\"><a href=\"#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B\" aria-label=\"三次握手 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>三次握手</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 543px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a98fd5b57c7cb69e93dd4c06df8f1eee/fcee8/3times.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.00000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFAv/EABUBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAGi6o4jJNFD/8QAGRAAAgMBAAAAAAAAAAAAAAAAAQIAAxET/9oACAEBAAEFAqie0RmypSLYiHP/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwEn/8QAFxEBAAMAAAAAAAAAAAAAAAAAAAECMf/aAAgBAgEBPwG2pf/EABsQAAIBBQAAAAAAAAAAAAAAAAABEAIDETFR/9oACAEBAAY/ArmW42yt9hn/xAAdEAADAAICAwAAAAAAAAAAAAAAARExUSFBYZHR/9oACAEBAAE/IWEMLpXyeyxc2xppPo52L0mT/9oADAMBAAIAAwAAABCEL//EABcRAAMBAAAAAAAAAAAAAAAAAAABETH/2gAIAQMBAT8QyKw//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QUV//xAAbEAEAAwADAQAAAAAAAAAAAAABABEhMVFh8f/aAAgBAQABPxA+BWxIa46glzre3q25REcsNU7ygfCCi23F88n/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"3times\"\n        title=\"3times\"\n        src=\"/static/a98fd5b57c7cb69e93dd4c06df8f1eee/fcee8/3times.jpg\"\n        srcset=\"/static/a98fd5b57c7cb69e93dd4c06df8f1eee/f93b5/3times.jpg 300w,\n/static/a98fd5b57c7cb69e93dd4c06df8f1eee/fcee8/3times.jpg 543w\"\n        sizes=\"(max-width: 543px) 100vw, 543px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>客户端首先要 SYN=1,表示要创建连接</li>\n<li>服务端接收到后，要告诉客户端：我接受到了！所以加个 ACK=1 表示确认跟客户端创建连接，因为 TCP 连接是双向的，然后还需要发送 SYN=1 表示我也想跟你连接</li>\n<li>理论上这时就创建连接成功（也就是半连接状态）了，但是要防止一个意外(也就是下面的为什么需要三次握手)，所以客户端要再发一个消息给服务端确认一下，这时只需要 ACK=1 就行了</li>\n<li>三次握手完成</li>\n</ol>\n<blockquote>\n<ul>\n<li>SYN：代表请求创建连接，所以在三次握手中前两次要 SYN=1，表示这两次用于建立连接；</li>\n<li>ACK：代表确认接受，不管是三次握手还是四次分手，在回应的时候都会加上 ACK=1，表示消息接收到了，并且在建立连接以后的发送数据时，都需加上 ACK=1,来表示数据接收成功；</li>\n<li>seq：序列号，什么意思呢？当发送一个数据时，数据是被拆成多个数据包来发送，序列号就是对每个数据包进行编号，这样接受方才能对数据包进行再次拼接。初始序列号是随机生成的，这样不一样的数据拆包解包就不会连接错了。（例如：两个数据都被拆成 1，2，3 和一个数据是 1，2，3 一个是 101，102，103，很明显后者不会连接错误）</li>\n<li>ack:这个代表下一个数据包的编号，这也就是为什么第二请求时，ack 是 seq+1，</li>\n<li>为什么需要三次握手？---------------如果一个连接请求在网络中跑的慢，超时了，这时客户端会重发请求，但是这个跑的慢的请求最后还是跑到了，然后服务端就接收了两个连接请求，然后全部回应就会创建两个连接，浪费资源！如果加了第三次客户端确认，服务端在接受到一个客户端连接确认请求后，后面再接收到的连接确认请求就可以抛弃不管了。<br />-------------- 还有一个原因是：因为 TCP 连接时双向的，所以不仅需要连接客户端和服务端的单向连接，还需要连接服务端和客户端的单向连接，在第二次服务端发送了 SYN=1 请求连接的时候还需要客户端发送 ACK=1 来确认连接才能成功双向连接。</li>\n</ul>\n</blockquote>\n<h2 id=\"四次分手\" style=\"position:relative;\"><a href=\"#%E5%9B%9B%E6%AC%A1%E5%88%86%E6%89%8B\" aria-label=\"四次分手 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>四次分手</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 564px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/263613d85ce82dc31dc9281013861de6/7723c/4times.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAADBf/EABYBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB6aRsQNnaT//EABkQAAIDAQAAAAAAAAAAAAAAAAABAgMRBP/aAAgBAQABBQKicpCelds2ufUIqTz/xAAWEQEBAQAAAAAAAAAAAAAAAAAAATH/2gAIAQMBAT8BmI//xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIRMf/aAAgBAgEBPwGWjo//xAAbEAABBAMAAAAAAAAAAAAAAAAAAQIRMRIhQf/aAAgBAQAGPwJ2Slm1HzNnSlP/xAAcEAACAgIDAAAAAAAAAAAAAAAAARExIVFBcYH/2gAIAQEAAT8htZDhYE0kMb5NC4BOg0qvRLzZo//aAAwDAQACAAMAAAAQaA//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/ENhnD//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAgEBPxDIwhq//8QAGhABAQEBAQEBAAAAAAAAAAAAAREhADFBwf/aAAgBAQABPxATxPAQ3jlLSXPT51taMMGQ47SCVFN5WwKmJ+cCeblXkO//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4times\"\n        title=\"4times\"\n        src=\"/static/263613d85ce82dc31dc9281013861de6/7723c/4times.jpg\"\n        srcset=\"/static/263613d85ce82dc31dc9281013861de6/f93b5/4times.jpg 300w,\n/static/263613d85ce82dc31dc9281013861de6/7723c/4times.jpg 564w\"\n        sizes=\"(max-width: 564px) 100vw, 564px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>首先客户端请求关闭客户端到服务端方向的连接，这时客户端就要发送一个 FIN=1，表示要关闭一个方向的连接（见上面四次分手的图）</li>\n<li>服务端接收到后是需要确认一下的，所以返回了一个 ACK=1,现在处于半关闭状态，服务端还可以发送数据给客户端（关闭了客户端向服务端发送数据的信道，但 TCB 还未销毁，仍可发送 ACK）</li>\n<li>这时只关闭了 TCP 一个方向，另一个方向也需要关闭,如果服务端没有数据发送给客户端了，服务端也向客户端发了一个 FIN=1 ,ACK=1，当然也要有 seq 和 ack</li>\n<li>客户端接收到后发送 ACK=1，表示接受成功</li>\n<li>服务端接收到客户端发来的 ACK=1 后关闭 TCP 连接，销毁 TCB（什么是 TCB 见下）</li>\n<li>客户端等到 2MSL 后再销毁 TCB（什么是 2MSL 见下）</li>\n<li>四次分手完成！</li>\n</ol>\n<blockquote>\n<ul>\n<li>FIN：表示请求关闭连接，在四次分手时，我们发现 FIN 发了两遍。这是因为 TCP 的连接是双向的，所以一次 FIN 只能关闭一个方向。</li>\n<li><strong>注意</strong>：TCB 传输控制块是客户端和服务端在请求连接和关闭连接时都会生成的，在请求连接成功和关闭连接成功时销毁，ACK，ack，FIN，seq 等通过 TCB 发送给对方。</li>\n<li>为什么客户端需要等到 2MSL 后才能关闭？---------------服务端在要分手的时候，如果由于某些网络原因没有收到客户端说的确认，那么它会再说一次分手，也就是重发 FIN，如果客户端在说完确认之后就关闭了 TCP 连接，那么服务端是不知道客户端到底能不能和它和平分手的，那么它的端口就一直不能关闭，所以需要客户端等待 2MSL 再关闭 TCP 连接。</li>\n<li>为什么需要四次分手？--------------TCP 是双向的，所以需要在两个方向分别关闭，每个方向的关闭又需要请求和确认，所以一共就 4 次。</li>\n<li>为什么服务端不一起发送 FIN 和 ACK 呢？这样才三次握手-----------------------在客户端说了分手之后，它还是可以接受数据的，只是不能发送而已，如果只有三次握手，服务端在没有发完数据的情况下就关闭了 TCP，那么客户端得到的数据是不完整的，所以服务端需要在客户端请求关闭连接的时候第一次就发送 ACK 说我收到了，但是你再等等，我还有数据没有发完给你，等发完之后，才发送 FIN 关闭 TCP 连接。</li>\n</ul>\n</blockquote>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<blockquote>\n<ul>\n<li>此文章参考链接：<a href=\"https://baijiahao.baidu.com/s?id=1593714120815701015&#x26;wfr=spider&#x26;for=pc\">TCP 的三次握手和四次分手</a></li>\n<li>2MSL 解释：<a href=\"https://blog.csdn.net/zxx2096/article/details/80286577\">2MSL 是什么？</a></li>\n</ul>\n</blockquote>"},"primaryTag":{"name":"Network","color":null}},"pageContext":{"postId":"544ca156-d750-5f5b-ab90-326ad1bfb1ad","primaryTag":"Network"}},"staticQueryHashes":["1116962356","2275848304","3097946992","3138592700","3462520645"]}