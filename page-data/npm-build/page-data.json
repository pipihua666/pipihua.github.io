{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/npm-build","result":{"data":{"post":{"id":"5376b62f-bcd9-55b2-93f4-eb9ddf901f79","headings":[{"depth":2},{"depth":2},{"depth":2},{"depth":3},{"depth":3},{"depth":3},{"depth":3},{"depth":3},{"depth":4},{"depth":4},{"depth":4},{"depth":2}],"frontmatter":{"title":"你的npm仓库也许不需要任何打包工具","path":"/npm-build","tags":["JavaScript"],"excerpt":"为什么npm包只需编译发布就好了，如何正确编译我们的npm包，并且sideEffects和babel-plugin-import实现按需加载的原理是什么？","created":"2022-06-19T00:00:00.000Z","createdPretty":"19 June, 2022","updated":"2022-12-05T00:00:00.000Z","updatedPretty":"05 December, 2022","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAIBAwQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdacybXKQ//EABkQAAMBAQEAAAAAAAAAAAAAAAABAhESMf/aAAgBAQABBQKXJaQ/dOmaz//EABcRAQADAAAAAAAAAAAAAAAAAAACEiH/2gAIAQMBAT8BrFj/xAAXEQEAAwAAAAAAAAAAAAAAAAAAARES/9oACAECAQE/AdSt/8QAFhAAAwAAAAAAAAAAAAAAAAAAESAh/9oACAEBAAY/AhG//8QAGxABAQACAwEAAAAAAAAAAAAAAQARMSFRYYH/2gAIAQEAAT8hAmC+yRTmPS3PJwbva//aAAwDAQACAAMAAAAQbN//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEUH/2gAIAQMBAT8Q2Q//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxCCn//EABsQAQEBAAIDAAAAAAAAAAAAAAERACExcYGR/9oACAEBAAE/EF6BO4r4yggrJhrr7ynj7XIXIreHLNV93//Z","aspectRatio":1.5151515151515151,"src":"/static/1a1058d06dad49e197366d0859a10965/f2cbb/header.jpg","srcSet":"/static/1a1058d06dad49e197366d0859a10965/8850c/header.jpg 200w,\n/static/1a1058d06dad49e197366d0859a10965/da113/header.jpg 400w,\n/static/1a1058d06dad49e197366d0859a10965/f2cbb/header.jpg 800w,\n/static/1a1058d06dad49e197366d0859a10965/c26c2/header.jpg 1200w,\n/static/1a1058d06dad49e197366d0859a10965/9352a/header.jpg 1600w,\n/static/1a1058d06dad49e197366d0859a10965/4fb49/header.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"为什么你的仓库不需要打包工具\" style=\"position:relative;\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E7%9A%84%E4%BB%93%E5%BA%93%E4%B8%8D%E9%9C%80%E8%A6%81%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7\" aria-label=\"为什么你的仓库不需要打包工具 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么你的仓库不需要打包工具</h2>\n<p>如果你的仓库使用的是打包工具进行编译和打包，那么</p>\n<ul>\n<li>优点是仓库对业务方没有影响</li>\n<li>缺点是它可能会增加仓库的复杂性，并且有可能对业务方造成一些限制</li>\n</ul>\n<p>举个实际性的例子，你的仓库可能会考虑通过异步的<code class=\"language-text\">import()</code>来进行代码分割，如果你将仓库打包成一个单一的<code class=\"language-text\">bundle</code>文件，然后业务方是无法通过异步的<code class=\"language-text\">import()</code>来对该仓库的代码进行代码分割的。</p>\n<h2 id=\"打包仓库前先考虑以下问题\" style=\"position:relative;\"><a href=\"#%E6%89%93%E5%8C%85%E4%BB%93%E5%BA%93%E5%89%8D%E5%85%88%E8%80%83%E8%99%91%E4%BB%A5%E4%B8%8B%E9%97%AE%E9%A2%98\" aria-label=\"打包仓库前先考虑以下问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>打包仓库前先考虑以下问题</h2>\n<p>如果你想生成一个<code class=\"language-text\">UMD</code>文件以至于能通过<code class=\"language-text\">&lt;script&gt;</code>标签来引入到业务方的项目中，或许你需要一个打包工具。但是未来<code class=\"language-text\">UMD</code>的形式将不再流行，你也许会更倾向于使用单一的<code class=\"language-text\">ESM</code>模块。但这都是后话了，你仍然需要考虑</p>\n<ul>\n<li>如果你不需要打包依赖项，那么使用打包工具的收益是什么？</li>\n<li>如果你需要打包依赖项，那么你就不允许业务方通过<code class=\"language-text\">semver</code>语义化的方式更新你的子依赖项吗？</li>\n</ul>\n<blockquote>\n<p>我的建议：别使用打包工具，<code class=\"language-text\">tsc</code>和<code class=\"language-text\">babel</code>能解决大部分的组件库编译场景</p>\n</blockquote>\n<h2 id=\"如何正确使用-babel-和-tsc-编译我们的-npm-包\" style=\"position:relative;\"><a href=\"#%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8-babel-%E5%92%8C-tsc-%E7%BC%96%E8%AF%91%E6%88%91%E4%BB%AC%E7%9A%84-npm-%E5%8C%85\" aria-label=\"如何正确使用 babel 和 tsc 编译我们的 npm 包 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>如何正确使用 babel 和 tsc 编译我们的 npm 包</h2>\n<h3 id=\"通过-babel-进行编译\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E8%BF%87-babel-%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91\" aria-label=\"通过 babel 进行编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通过 babel 进行编译</h3>\n<p>.babelrc 关键配置示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">export default <span class=\"token punctuation\">{</span>\n  <span class=\"token key atrule\">presets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">modules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span><span class=\"token punctuation\">,</span>  // 保持ES modules，可根据需求修改\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-typescript'</span><span class=\"token punctuation\">,</span> // 编译ts\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      '@babel/plugin<span class=\"token punctuation\">-</span>transform<span class=\"token punctuation\">-</span>runtime' // 将通用helper方法通过@babel/runtime的形式引入\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">modules:false</code>：保持 ES modules，我的是前端环境，可根据自身需求修改</li>\n<li>也许你会问我为什么不引入<code class=\"language-text\">usage</code>的 polyfill，个人建议不在 npm 包中引入 polyfill，有可能你引入的和业务方的有冲突，写好库的 README 比什么都强</li>\n</ul>\n<h3 id=\"通过-tsc-对类型进行检查并生成声明文件\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E8%BF%87-tsc-%E5%AF%B9%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5%E5%B9%B6%E7%94%9F%E6%88%90%E5%A3%B0%E6%98%8E%E6%96%87%E4%BB%B6\" aria-label=\"通过 tsc 对类型进行检查并生成声明文件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通过 tsc 对类型进行检查并生成声明文件</h3>\n<p>tsconfig.json 配置示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"include\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"target\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"es2018\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"outDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lib\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"dom\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"esnext\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"declaration\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// \"moduleResolution\": \"node\",</span>\n    <span class=\"token property\">\"sourceMap\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"strict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"esModuleInterop\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">moduleResolution:node</code>：如果你不使用 ES modules，那么你应该设置此属性</li>\n</ul>\n<h3 id=\"修改包配置启用编译\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E6%94%B9%E5%8C%85%E9%85%8D%E7%BD%AE%E5%90%AF%E7%94%A8%E7%BC%96%E8%AF%91\" aria-label=\"修改包配置启用编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修改包配置启用编译</h3>\n<p>package.json 示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hello-world\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"module\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"prebuild\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf dist &amp;&amp; tsc\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"babel src --out-dir dist --extensions '.ts,.tsx' --delete-dir-on-start --source-maps\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"files\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dist\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"peerDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"antd\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.0.0\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>files 里面为啥要包括 src 目录？ - 为了方便 sourcemap</li>\n<li>\n<p>antd 为什么要放在 peerDependencies 里？ -</p>\n<ol>\n<li>为了防止和业务方的 antd 仓库冲突；</li>\n<li>为了防止 antd 仓库的多次安装</li>\n</ol>\n</li>\n</ul>\n<p>顺便提一嘴仓库在使用 dependencies 声明依赖库的特点，来表明仓库使用 peerDependencies 的重要性</p>\n<ul>\n<li>业务方显示依赖的核心库，会忽略仓库的 peerDependency 声明</li>\n<li>业务方没有显示依赖核心库，则按照插件的 peerDependency 中声明的版本将库安装到项目根目录中</li>\n<li>当业务方依赖的版本和仓库依赖的版本不一致，会报错让用户修复</li>\n</ul>\n<p>所以一般会有冲突的包，比如<code class=\"language-text\">react-dom</code>、<code class=\"language-text\">react</code>、<code class=\"language-text\">antd</code>等都可通过放在 peerDependency 中引入，就不会和业务方的版本冲突啦！</p>\n<p>那么问题来了，peerDependency 在开的时候很影响开发体验啊，<code class=\"language-text\">npm install</code>不会安装它。解决方法如下：</p>\n<ol>\n<li>npm i -D install-peers-cli</li>\n<li>在 npm scripts 中添加 <code class=\"language-text\">&quot;prepare&quot;: &quot;install-peers&quot;,</code>，prepare 会在每次<code class=\"language-text\">npm install</code>后执行，非常 nice~</li>\n</ol>\n<blockquote>\n<p>当然，你也可以既兼容 cjs，也可兼容 esm。去除 type:module，添加 module: esm/index.js 为 ESM 的入口，main：dist/index.js 为 Commonjs 的入口，如果业务方不支持 esm 会进入到 main 入口哒~</p>\n</blockquote>\n<h3 id=\"处理样式文件\" style=\"position:relative;\"><a href=\"#%E5%A4%84%E7%90%86%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6\" aria-label=\"处理样式文件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>处理样式文件</h3>\n<p>有以下四种方案：</p>\n<ol>\n<li>告知业务方增加 less-loader。会导致业务方使用成本增加；</li>\n<li>打包出一份完整的 css 文件，进行全量引入。无法进行按需引入；</li>\n<li>css in js 方案；</li>\n<li>每个组自己提供一份 css.js 文件，引入该组件 css 样式依赖，而非 less 依赖，组件库底层抹平差异。</li>\n</ol>\n<blockquote>\n<p>对于组件库来说，如果需要开放出去，最好考虑 3 和 4 方案，优缺点可看我参考的 React 组件库编译打包文章</p>\n</blockquote>\n<p>由于我这里是公司内部使用，采用一方案了直接拷贝 less 文件:</p>\n<p>在 babel 参数添加 <code class=\"language-text\">--copy-files</code> ，会自动将不符合编译条件（未编译）的文件拷贝到目标文件夹中，这样做的缺点很明显,若业务方没使用 less 预处理器，使用的是 sass 方案甚至原生 css 方案，那现有方案就搞不定了。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">babel src <span class=\"token operator\">--</span>out<span class=\"token operator\">-</span>dir dist <span class=\"token operator\">--</span>extensions <span class=\"token string\">'.ts,.tsx'</span> <span class=\"token operator\">--</span><span class=\"token keyword\">delete</span><span class=\"token operator\">-</span>dir<span class=\"token operator\">-</span>on<span class=\"token operator\">-</span>start <span class=\"token operator\">--</span>source<span class=\"token operator\">-</span>maps <span class=\"token operator\">--</span>copy<span class=\"token operator\">-</span>files</code></pre></div>\n<p>如果需要在保持开发体验的同时，减少业务方使用的成本。那就最好采用 2,3,4 方案。如果还需要按需加载 css 样式的要求，那就只能考虑 3,4 方案了。4 方案是 antd 采用的方案，但是需要业务方自己手动<b>管理依赖</b>，但是也可以通过 babel-plugin-import 插件来自动帮我们管理依赖。看了以下示例你们就懂第四种的方式了。</p>\n<p>假设我们有以下文件：</p>\n<ul>\n<li>css.js</li>\n<li>Button.jsx</li>\n<li>styles.less</li>\n</ul>\n<p>css.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token string\">\"style.less\"</span></code></pre></div>\n<p>Example.jsx 文件中不引入样式文件，如果业务方要使用我们的组件，他们需要</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Button <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"ui\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"ui/Button/css\"</span></code></pre></div>\n<p>我们需要构建的时候就可以抹平这些差异，将<code class=\"language-text\">styles.less</code>编译成<code class=\"language-text\">styles.css</code>,再将<code class=\"language-text\">css.js</code>中的内容替换成<code class=\"language-text\">import styles.css</code>就可以了。这样不仅可以兼顾开发体验和使用成本，还能按需加载样式，但是增加了使用成本，下面会介绍 babel-plugin-import 插件。</p>\n<h3 id=\"按需加载\" style=\"position:relative;\"><a href=\"#%E6%8C%89%E9%9C%80%E5%8A%A0%E8%BD%BD\" aria-label=\"按需加载 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>按需加载</h3>\n<blockquote>\n<p>按需加载的原理是结合 ES module 和 tree-shaking 特性实现</p>\n</blockquote>\n<p>说到按需加载，就不得聊聊 package.json 中的<code class=\"language-text\">sideEffects</code>属性和 babel 的<a href=\"https://www.npmjs.com/package/babel-plugin-import\">babel-plugin-import 插件</a>，两者的相识点都是将类似<code class=\"language-text\">import {array} from lodash</code> 转化为<code class=\"language-text\">import array from lodash/array</code>，改变组件的引用路径实现按需加载，如果你的组件库有个统一的导出出口 index.js 就没必要用这些了。</p>\n<h4 id=\"sideeffects\" style=\"position:relative;\"><a href=\"#sideeffects\" aria-label=\"sideeffects permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>sideEffects</h4>\n<p>说一下它常用的两个类型</p>\n<ul>\n<li>false：标记哪些文件没有副作用，则表示组件库的所有 js 文件都没有副作用，可以用路径替换的方式<b>放心</b>实现 tree-shaking。</li>\n<li>数组：数组内的文件都标记为有副作用的，打包工具不能将这些文件 shaking 掉。有个常见的 bug 就是样式丢失，如果不设置 sideEffects:[<em>.less,</em>.css]，如果你在业务代码中<code class=\"language-text\">import styles.less</code>，会导致最后打包的文件没有你想要的样式，因为打包工具认为没有地方引用到了该文件的内容。</li>\n</ul>\n<h4 id=\"babel-plugin-import\" style=\"position:relative;\"><a href=\"#babel-plugin-import\" aria-label=\"babel plugin import permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>babel-plugin-import</h4>\n<p>该插件决定将哪个库通过改变路径来实现 tree-shaking，有个关于样式按需加载的属性是<code class=\"language-text\">style</code>,当我们不想通过<code class=\"language-text\">css in js</code>的方案进行样式加载的时候，我们需要告知业务方，你引入了我们的组件，但是你也要引入它的样式，也就是我们第四种方案。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Button <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"ui\"</span>\n<span class=\"token keyword\">import</span> <span class=\"token string\">\"/ui/Button/style\"</span></code></pre></div>\n<p>但是这样对于业务方来说，他们不可能引入一个组件就引入一个样式啊，这样的使用体验也太不好了。当然，组件库也可以导出一个完成的样式文件，只引入一次就够了，但是这又与我们的按需加载相去甚远。此时，告知业务方去使用 babel-plugin-import 的 style 属性就很重要。</p>\n<p>通过插件源码可以发现：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>style <span class=\"token operator\">===</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">addSideEffect</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/style</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>style <span class=\"token operator\">===</span> <span class=\"token string\">'css'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">addSideEffect</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>path<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/style/css</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p><code class=\"language-text\">style</code>属性的作用是当你引入组件库的时候，自动在业务组件中插入 <code class=\"language-text\">import Button/style</code> 或 <code class=\"language-text\">import Button/style/css</code> 代码来按需引入样式的 js 文件</p>\n</blockquote>\n<p>注意：两者的区别，<code class=\"language-text\">style: true</code>在编译时引入源文件而<code class=\"language-text\">style: “css”</code>在打包前按引入源文件。在编译时引入文件能有效利用 tree-shaking 减少 bundle 体积，而在打包前不能，这是 ES module 静态 import 的特性。</p>\n<h4 id=\"q--a\" style=\"position:relative;\"><a href=\"#q--a\" aria-label=\"q  a permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Q &#x26; A</h4>\n<ol>\n<li>\n<p>为什么不在 Button 中直接引入<code class=\"language-text\">import style</code>来引入 css 文件呢，这样外部就不用考虑 css 的按需加载了？</p>\n<blockquote>\n<p>如果需要覆盖 less 变量或者主题定制是有必要直接使用 less 的，但也可以使用 css vars 实现</p>\n</blockquote>\n</li>\n</ol>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler\">You may not need a bundler for your NPM library</a></li>\n<li><a href=\"https://github.com/worldzhao/blog/issues/5\">React 组件库编译打包</a></li>\n<li><a href=\"https://github1s.com/umijs/babel-plugin-import/blob/master/src/Plugin.js\">babel-plugin-import 源码</a></li>\n<li><a href=\"https://babeljs.io/docs/en/babel-helper-module-imports\">babel-helper-module-imports 工具插件</a></li>\n</ul>"},"primaryTag":{"name":"JavaScript","color":"#1e81b0"}},"pageContext":{"postId":"5376b62f-bcd9-55b2-93f4-eb9ddf901f79","primaryTag":"JavaScript"}},"staticQueryHashes":["1116962356","2275848304","3097946992","3138592700","3462520645"]}