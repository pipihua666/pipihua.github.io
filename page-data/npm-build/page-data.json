{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/npm-build","result":{"data":{"post":{"id":"5376b62f-bcd9-55b2-93f4-eb9ddf901f79","headings":[{"depth":2},{"depth":2},{"depth":2},{"depth":3},{"depth":3},{"depth":3},{"depth":2}],"frontmatter":{"title":"你的npm仓库也许不需要任何打包工具","path":"/npm-build","tags":["JavaScript"],"excerpt":"在工作过程中，发现有很多同事发布的npm仓库都是通过webpack打包发布的，接下来听我狡辩，我们前端攻城狮为什么发布npm不需要webpack以及应该怎样发布我们的包","created":"2022-06-19 21:00","createdPretty":"19 June, 2022","updated":"2022-06-19 21:00","updatedPretty":"19 June, 2022","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAIBAwQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdacybXKQ//EABkQAAMBAQEAAAAAAAAAAAAAAAABAhESMf/aAAgBAQABBQKXJaQ/dOmaz//EABcRAQADAAAAAAAAAAAAAAAAAAACEiH/2gAIAQMBAT8BrFj/xAAXEQEAAwAAAAAAAAAAAAAAAAAAARES/9oACAECAQE/AdSt/8QAFhAAAwAAAAAAAAAAAAAAAAAAESAh/9oACAEBAAY/AhG//8QAGxABAQACAwEAAAAAAAAAAAAAAQARMSFRYYH/2gAIAQEAAT8hAmC+yRTmPS3PJwbva//aAAwDAQACAAMAAAAQbN//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEUH/2gAIAQMBAT8Q2Q//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxCCn//EABsQAQEBAAIDAAAAAAAAAAAAAAERACExcYGR/9oACAEBAAE/EF6BO4r4yggrJhrr7ynj7XIXIreHLNV93//Z","aspectRatio":1.5151515151515151,"src":"/static/1a1058d06dad49e197366d0859a10965/f2cbb/header.jpg","srcSet":"/static/1a1058d06dad49e197366d0859a10965/8850c/header.jpg 200w,\n/static/1a1058d06dad49e197366d0859a10965/da113/header.jpg 400w,\n/static/1a1058d06dad49e197366d0859a10965/f2cbb/header.jpg 800w,\n/static/1a1058d06dad49e197366d0859a10965/c26c2/header.jpg 1200w,\n/static/1a1058d06dad49e197366d0859a10965/9352a/header.jpg 1600w,\n/static/1a1058d06dad49e197366d0859a10965/4fb49/header.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<blockquote>\n<p>以下包的使用者简称为消费者</p>\n</blockquote>\n<h2 id=\"为什么你的仓库不需要打包工具\" style=\"position:relative;\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E7%9A%84%E4%BB%93%E5%BA%93%E4%B8%8D%E9%9C%80%E8%A6%81%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7\" aria-label=\"为什么你的仓库不需要打包工具 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么你的仓库不需要打包工具</h2>\n<p>如果你的仓库使用的是打包工具进行编译和打包，那么</p>\n<ul>\n<li>优点是仓库对消费者没有影响</li>\n<li>缺点是它可能会增加仓库的复杂性，并且有可能对消费者造成一些限制</li>\n</ul>\n<p>举个实际性的例子，你的仓库可能会考虑通过异步的<code class=\"language-text\">import()</code>来进行代码分割，如果你将仓库打包成一个单一的<code class=\"language-text\">bundle</code>文件，然后消费者是无法通过异步的<code class=\"language-text\">import()</code>来对该仓库的代码进行代码分割的。</p>\n<h2 id=\"为什么你想通过打包工具来打包你的仓库\" style=\"position:relative;\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%83%B3%E9%80%9A%E8%BF%87%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7%E6%9D%A5%E6%89%93%E5%8C%85%E4%BD%A0%E7%9A%84%E4%BB%93%E5%BA%93\" aria-label=\"为什么你想通过打包工具来打包你的仓库 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么你想通过打包工具来打包你的仓库</h2>\n<p>如果你想生成一个<code class=\"language-text\">UMD</code>文件以至于能通过<code class=\"language-text\">&lt;script&gt;</code>标签来引入到消费者的项目中，或者你需要一个打包工具，但是未来<code class=\"language-text\">UMD</code>的形式将不再流行，你也许会更倾向于使用单一的<code class=\"language-text\">ESM</code>模块。但这都是后话了，你仍然需要考虑</p>\n<ul>\n<li>如果你不需要打包依赖项，那么使用打包工具的收益是什么？</li>\n<li>如果你需要打包依赖项，那么你就不允许消费者通过<code class=\"language-text\">semver</code>语义化的方式更新你的子依赖项吗？</li>\n</ul>\n<blockquote>\n<p>我的建议：别使用打包工具，<code class=\"language-text\">tsc</code>和<code class=\"language-text\">babel</code>能解决大部分的组件库编译场景</p>\n</blockquote>\n<h2 id=\"将一个-webpack-打包编译的仓库转换成单纯的-babel-和-tsc-编译\" style=\"position:relative;\"><a href=\"#%E5%B0%86%E4%B8%80%E4%B8%AA-webpack-%E6%89%93%E5%8C%85%E7%BC%96%E8%AF%91%E7%9A%84%E4%BB%93%E5%BA%93%E8%BD%AC%E6%8D%A2%E6%88%90%E5%8D%95%E7%BA%AF%E7%9A%84-babel-%E5%92%8C-tsc-%E7%BC%96%E8%AF%91\" aria-label=\"将一个 webpack 打包编译的仓库转换成单纯的 babel 和 tsc 编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>将一个 webpack 打包编译的仓库转换成单纯的 babel 和 tsc 编译</h2>\n<h3 id=\"通过-babel-进行编译\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E8%BF%87-babel-%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91\" aria-label=\"通过 babel 进行编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通过 babel 进行编译</h3>\n<p>.babelrc 关键配置示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\">export default <span class=\"token punctuation\">{</span>\n  <span class=\"token key atrule\">presets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">modules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span><span class=\"token punctuation\">,</span>  // 保持ES modules，可根据需求修改\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'@babel/preset-typescript'</span><span class=\"token punctuation\">,</span> // 编译ts\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token key atrule\">plugins</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'transform-inline-environment-variables'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"NODE_ENV\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token string\">'babel-plugin-add-import-extension'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">modules:false</code>：保持 ES modules，我的是前端环境，可根据自身需求修改</li>\n<li><code class=\"language-text\">transform-inline-environment-variables</code>：babel 编译环境变量注入。替换 Webpack.DefinePlugin 的环境变量注入</li>\n<li><code class=\"language-text\">babel-plugin-add-import-extension</code>：自动添加.js 后缀。由于<code class=\"language-text\">package.json</code>中的 type 字段为 module，webpack 对该 type 类型的仓库比较严格，需要所有 import 的文件都有.js 或.mjs 后缀</li>\n</ul>\n<h3 id=\"通过-tsc-对类型进行检查\" style=\"position:relative;\"><a href=\"#%E9%80%9A%E8%BF%87-tsc-%E5%AF%B9%E7%B1%BB%E5%9E%8B%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5\" aria-label=\"通过 tsc 对类型进行检查 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>通过 tsc 对类型进行检查</h3>\n<p>tsconfig.json 配置示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"include\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"target\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"es2018\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"outDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"lib\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"dom\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"esnext\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"declaration\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// \"moduleResolution\": \"node\",</span>\n    <span class=\"token property\">\"sourceMap\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"strict\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"esModuleInterop\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">moduleResolution:node</code>：如果你不使用 ES modules，那么你应该设置此属性</li>\n</ul>\n<h3 id=\"修改包配置启用编译\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E6%94%B9%E5%8C%85%E9%85%8D%E7%BD%AE%E5%90%AF%E7%94%A8%E7%BC%96%E8%AF%91\" aria-label=\"修改包配置启用编译 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修改包配置启用编译</h3>\n<p>package.json 示例如下</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"hello-world\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"main\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/index.js\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"types\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dist/types\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"module\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"prebuild\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rimraf dist &amp;&amp; tsc\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"babel src --out-dir dist --extensions '.ts,.tsx'\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"files\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"src\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dist\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"peerDependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"antd\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^4.0.0\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>files 里面为啥要包括 src 目录？ - 为了方便 sourcemap</li>\n<li>antd 为什么要放在 peerDependencies 里？ - 1. 为了防止和消费者的 antd 仓库冲突；2. 为了防止 antd 仓库的多次安装</li>\n</ul>\n<p>顺便提一嘴仓库在使用 dependencies 声明依赖库的特点，来表明仓库使用 peerDependencies 的重要性</p>\n<ul>\n<li>消费者显示依赖的核心库，会忽略仓库的 peerDependency 声明</li>\n<li>消费者没有显示依赖核心库，则按照插件的 peerDependency 中声明的版本将库安装到项目根目录中</li>\n<li>当消费者依赖的版本和仓库依赖的版本不一致，会报错让用户修复</li>\n</ul>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li><a href=\"https://cmdcolin.github.io/posts/2022-05-27-youmaynotneedabundler\">You may not need a bundler for your NPM library</a></li>\n</ul>"},"primaryTag":{"name":"JavaScript","color":"#1e81b0"}},"pageContext":{"postId":"5376b62f-bcd9-55b2-93f4-eb9ddf901f79","primaryTag":"JavaScript"}},"staticQueryHashes":["1116962356","2275848304","3097946992","3138592700","3462520645"]}