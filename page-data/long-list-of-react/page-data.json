{"componentChunkName":"component---src-templates-blog-post-js","path":"/long-list-of-react/","result":{"data":{"site":{"siteMetadata":{"title":"皮皮花的博客"}},"markdownRemark":{"id":"272d5071-ec39-5eda-9967-7f1541b46076","excerpt":"一、虚拟列表优化长列表的原理 优化长列表的原理很简单，基本原理可以一句话概括：用数组保存所有列表元素的位置，只渲染可视区内的列表元素，当可视区滚动时，根据滚动的 offset 大小以及所有列表元素的位置，计算在可视区应该渲染哪些元素。…","html":"<p><a name=\"TWtP7\"></a></p>\n<h2>一、虚拟列表优化长列表的原理</h2>\n<p><br />优化长列表的原理很简单，基本原理可以一句话概括：<br /><em><strong>用数组保存所有列表元素的位置，只渲染可视区内的列表元素，当可视区滚动时，根据滚动的 offset 大小以及所有列表元素的位置，计算在可视区应该渲染哪些元素。</strong></em><br />_<br />具体实现步骤如下所示：</p>\n<ol>\n<li>首先确定长列表所在父元素的大小，父元素的大小决定了可视区的宽和高</li>\n<li>确定长列表每一个列表元素的宽和高，同时初始的条件下计算好长列表每一个元素相对于父元素的位置，并用一个数组来保存所有列表元素的位置信息</li>\n<li>首次渲染时，只展示相对于父元素可视区内的子列表元素，在滚动时，根据父元素的滚动的 offset 重新计算应该在可视区内的子列表元素。这样保证了无论如何滚动，真实渲染出的 dom 节点只有可视区内的列表元素。</li>\n<li>假设可视区内能展示 5 个子列表元素，及时长列表总共有 1000 个元素，但是每时每刻，真实渲染出来的 dom 节点只有 5 个。</li>\n<li>补充说明，这种情况下，父元素一般使用 position：relative，子元素的定位一般使用：position：absolute 或 sticky</li>\n</ol>\n<p><a name=\"PXTg1\"></a></p>\n<h2>二、通过 react-virtualized 来优化长列表</h2>\n<p>react-virtualized 的基础组件包含：</p>\n<ul>\n<li>Grid：用于优化构建任意网状的结构，传入一个二维的数组，渲染出类似棋盘的结构。</li>\n<li>List：List 是基于 Grid 来实现的，但是是一个维的列表，而不是网状。</li>\n<li>Table：Table 也是基于 Grid 来实现，表格具有固定的头部，并且可以在垂直方向上滚动</li>\n<li>Masonry：同样可以在水平方向，也可以在垂直方向滚动，不同于 Grid 的是可以自定义每个元素的大小，或者子元素的大小也可以是动态变化的</li>\n<li>Collection：类似于瀑布流的形式，同样可以水平和垂直方向滚动。</li>\n</ul>\n<p><br />值得注意的是这些基础组件都是继承于 React 中的 PureComponent，因此当 state 变化的时候，只会做一个浅比较来确定重新渲染与否 。<br />\n<br />除了这几个基础组件外，react-virtualized 还提供了几个高阶组件，比如 ArrowKeyStepper 、AutoSizer、CellMeasurer、InfiniteLoader 等，本文具体介绍常用的 AutoSizer、CellMeasurer 和 InfiniteLoader。<br /></p>\n<ul>\n<li>AutoSizer：使用于一个子元素的情况，通过 AutoSizer 包含的子元素会根据父元素 Resize 的变化，自动调节该子元素的可视区的宽度和高度，同时调节的还有该子元素可视区真实渲染的 dom 元素的数目。(子元素会随父元素的长、宽自适应)</li>\n<li>CellMeasurer：这个高阶组件可以动态的改变子元素的高度，适用于提前不知道长列表中每一个子元素高度的情况。（会损耗性能，不建议使用）</li>\n<li>InfiniteLoader：这个高阶组件用于 Table 或者 List 的无限滚动，适用于滚动时异步请求等情况。（滚动加载）</li>\n</ul>\n<p><br />作者：yuxiaoliang<br />链接：<a href=\"https://juejin.cn/post/6844903729460674567\">https://juejin.cn/post/6844903729460674567</a><br />来源：掘金<br />著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。<br />\n<br /></p>\n<p><a name=\"t7LD9\"></a></p>\n<h2>三、Vlist 的实际使用</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List</span></span> <span class=\"token attr-name\">loading</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>loading<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">bordered</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  // antd的List组件\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> height<span class=\"token operator\">:</span> <span class=\"token number\">420</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    // vlist父元素的高度\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AutoSizer</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token punctuation\">{</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      // 可根据父元素的高度动态计算出列表项的高度\n      </span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&lt;</span>VList\n          width<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span> <span class=\"token comment\">// 列表的宽度</span>\n          height<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>height<span class=\"token punctuation\">}</span> <span class=\"token comment\">// 列表的高度</span>\n          rowCount<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>pocList<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">}</span> <span class=\"token comment\">// 列表项数</span>\n          overscanRowCount<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">7</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// 不在视窗范围上下现实的列表项数</span>\n          rowHeight<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">60</span><span class=\"token punctuation\">}</span> <span class=\"token comment\">// 列表项的高</span>\n          rowRenderer<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>renderItem<span class=\"token punctuation\">}</span> <span class=\"token comment\">// 列表项渲染方式</span>\n          noRowsRenderer<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n            <span class=\"token comment\">// 空数据的渲染方式</span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Empty</span></span>\n              <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n                position<span class=\"token operator\">:</span> <span class=\"token string\">\"absolute\"</span><span class=\"token punctuation\">,</span>\n                top<span class=\"token operator\">:</span> <span class=\"token string\">\"50%\"</span><span class=\"token punctuation\">,</span>\n                left<span class=\"token operator\">:</span> <span class=\"token string\">\"50%\"</span><span class=\"token punctuation\">,</span>\n                transform<span class=\"token operator\">:</span> <span class=\"token string\">\"translate(-60%,-50%)\"</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">AutoSizer</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">List</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// key：数组行中的唯一值</span>\n<span class=\"token comment\">// style: vlist的列表项的定位样式和默认样式</span>\n<span class=\"token comment\">// parent: 参考父级Grid元素（使用CellMeasurer组件要注意：该组件会不断估算每个</span>\n<span class=\"token comment\">// 列表项的最佳高度，所以会带来一定的性能损耗，个人建议不要使用该组件，可以像我一样将</span>\n<span class=\"token comment\">// 列表项的高度rowHeight写死）</span>\n<span class=\"token comment\">// index: 被渲染数据的index索引</span>\n<span class=\"token function-variable function\">renderItem</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> index<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> style<span class=\"token operator\">:</span> styles <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> pocList <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state\n  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> pocList<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">List.Item</span></span> <span class=\"token attr-name\">style</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>styles<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tooltip</span></span> <span class=\"token attr-name\">title</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Checkbox</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>pocList<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>poc_id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token punctuation\">{</span>React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"span\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n            <span class=\"token operator\">...</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">highLightValue</span><span class=\"token punctuation\">(</span><span class=\"token function\">ellipsis</span><span class=\"token punctuation\">(</span>pocList<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span> <span class=\"token number\">46</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Checkbox</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Tooltip</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">List.Item</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br />其他优秀的社区库：</p>\n<ol>\n<li><a href=\"https://ali-react-table.js.org/docs/\">阿里的 ant-table 的丰富 api 虚拟表格</a></li>\n<li><a href=\"https://github.com/ctq123/ant-virtual-table\">兼容性比较好的虚拟表格</a></li>\n</ol>","frontmatter":{"title":"在React项目中，如何优雅的优化长列表","date":"December 14, 2020","description":"react的长列表的优化方案-react-virtualized"}},"previous":{"fields":{"slug":"/hello-world/"},"frontmatter":{"title":"Hello World"}},"next":{"fields":{"slug":"/wireshark/"},"frontmatter":{"title":"wireshark过滤器表达式"}}},"pageContext":{"id":"272d5071-ec39-5eda-9967-7f1541b46076","previousPostId":"2d5324d9-82f9-54a6-a406-a5309d982b1b","nextPostId":"04d86673-ef44-5a8b-93a3-09520a295092"}},"staticQueryHashes":["2841359383","3122794013"]}