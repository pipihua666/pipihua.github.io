{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/nginx-https","result":{"data":{"post":{"id":"fb135f83-6ea6-5248-9831-1834eca0b945","headings":[{"depth":2},{"depth":3},{"depth":3},{"depth":2},{"depth":3},{"depth":3},{"depth":3},{"depth":2}],"frontmatter":{"title":"nginx配置https及nginx安全配置","path":"/nginx-https","tags":["DevOps"],"excerpt":"nginx配置https及nginx安全配置","created":"2021-04-28 21:48","createdPretty":"28 April, 2021","updated":"2021-05-19 23:15","updatedPretty":"19 May, 2021","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAQFAwb/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAV3ee00pEor/xAAaEAADAQADAAAAAAAAAAAAAAAAAQISAxMi/9oACAEBAAEFAuDElWnPihW0dtG6P//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/Aar/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARL/2gAIAQIBAT8Blaf/xAAbEAACAQUAAAAAAAAAAAAAAAAAESEBECIxQf/aAAgBAQAGPwJplceERfZ//8QAGRAAAwEBAQAAAAAAAAAAAAAAAAERQSEx/9oACAEBAAE/IWakvNxj9iuKPg4Sajwmc5Rk/9oADAMBAAIAAwAAABAnL//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/EKU//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Qif/EABsQAQADAAMBAAAAAAAAAAAAAAEAESEQMWGR/9oACAEBAAE/EMY5yvoxO2zC2oQPUFaPvEi2kIh7fZ//2Q==","aspectRatio":1.4388489208633093,"src":"/static/83a40cbba25cea1b5f61341b2cc07096/f2cbb/image.jpg","srcSet":"/static/83a40cbba25cea1b5f61341b2cc07096/8850c/image.jpg 200w,\n/static/83a40cbba25cea1b5f61341b2cc07096/da113/image.jpg 400w,\n/static/83a40cbba25cea1b5f61341b2cc07096/f2cbb/image.jpg 800w,\n/static/83a40cbba25cea1b5f61341b2cc07096/c26c2/image.jpg 1200w,\n/static/83a40cbba25cea1b5f61341b2cc07096/9352a/image.jpg 1600w,\n/static/83a40cbba25cea1b5f61341b2cc07096/4fb49/image.jpg 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"nginx-的主要配置\" style=\"position:relative;\"><a href=\"#nginx-%E7%9A%84%E4%B8%BB%E8%A6%81%E9%85%8D%E7%BD%AE\" aria-label=\"nginx 的主要配置 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nginx 的主要配置</h2>\n<h3 id=\"转发-http-为-https\" style=\"position:relative;\"><a href=\"#%E8%BD%AC%E5%8F%91-http-%E4%B8%BA-https\" aria-label=\"转发 http 为 https permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>转发 http 为 https</h3>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">listen</span> <span class=\"token number\">80</span> default_server<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">80</span> default_server<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\"># 配置访问80http重定向到443的https，如果想开放80可以不配置</span>\n\t<span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>$ <span class=\"token keyword\">https</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token variable\">$host</span>$<span class=\"token number\">1</span> permanent<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"添加-https-配置\" style=\"position:relative;\"><a href=\"#%E6%B7%BB%E5%8A%A0-https-%E9%85%8D%E7%BD%AE\" aria-label=\"添加 https 配置 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>添加 https 配置</h3>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">server</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">listen</span> <span class=\"token number\">443</span> <span class=\"token keyword\">ssl</span> default_server<span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">listen</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span><span class=\"token number\">443</span> <span class=\"token keyword\">ssl</span> default_server<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\"># SSL configuration</span>\n    <span class=\"token comment\"># 证书的绝对路径</span>\n\t<span class=\"token keyword\">ssl_certificate</span>     <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>certs<span class=\"token operator\">/</span>cert<span class=\"token punctuation\">.</span>crt<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\"># 私钥的绝对路径</span>\n    <span class=\"token keyword\">ssl_certificate_key</span> <span class=\"token operator\">/</span>etc<span class=\"token operator\">/</span>nginx<span class=\"token operator\">/</span>certs<span class=\"token operator\">/</span>cert<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\"># enable session resumption to improve https performance</span>\n  \t<span class=\"token keyword\">ssl_session_cache</span> shared<span class=\"token punctuation\">:</span><span class=\"token keyword\">SSL</span><span class=\"token punctuation\">:</span><span class=\"token number\">50</span>m<span class=\"token punctuation\">;</span>\n  \t<span class=\"token keyword\">ssl_session_timeout</span> <span class=\"token number\">1</span>d<span class=\"token punctuation\">;</span>\n  \t<span class=\"token keyword\">ssl_session_tickets</span> off<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"没钱的打工人只能自签证书\" style=\"position:relative;\"><a href=\"#%E6%B2%A1%E9%92%B1%E7%9A%84%E6%89%93%E5%B7%A5%E4%BA%BA%E5%8F%AA%E8%83%BD%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6\" aria-label=\"没钱的打工人只能自签证书 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>没钱的打工人只能自签证书</h2>\n<p>自行安装 openssl 工具</p>\n<h3 id=\"https-自签发-ca-证书并实现网站可信自欺欺人\" style=\"position:relative;\"><a href=\"#https-%E8%87%AA%E7%AD%BE%E5%8F%91-ca-%E8%AF%81%E4%B9%A6%E5%B9%B6%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%AB%99%E5%8F%AF%E4%BF%A1%E8%87%AA%E6%AC%BA%E6%AC%BA%E4%BA%BA\" aria-label=\"https 自签发 ca 证书并实现网站可信自欺欺人 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTPS 自签发 CA 证书并实现网站可信(自欺欺人)</h3>\n<blockquote>\n<p>参考:<a href=\"https://jinyy.app/article/https-ca/\">HTTPS 自签发 CA 证书</a></p>\n</blockquote>\n<h3 id=\"遇到-ios-13-与-macos-1015-不支持自签证书\" style=\"position:relative;\"><a href=\"#%E9%81%87%E5%88%B0-ios-13-%E4%B8%8E-macos-1015-%E4%B8%8D%E6%94%AF%E6%8C%81%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6\" aria-label=\"遇到 ios 13 与 macos 1015 不支持自签证书 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>遇到 iOS 13 与 macOS 10.15 不支持自签证书</h3>\n<blockquote>\n<p>参考:<a href=\"https://jinyy.app/article/https-ca-2019/\">新版自签名 CA 证书生成</a></p>\n</blockquote>\n<h3 id=\"一键生成自签证书和私钥\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E9%94%AE%E7%94%9F%E6%88%90%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5\" aria-label=\"一键生成自签证书和私钥 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一键生成自签证书和私钥</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"> openssl req -out cert.crt -new -newkey rsa:2048  -nodes -keyout cert.key -x509 -days <span class=\"token number\">3650</span> -subj <span class=\"token string\">\"/C=[国家或地区]/ST=[省/市/自治区]/L=[所在地]/O=[组织]/OU=[组织单位]/CN=[常用名称]\"</span></code></pre></div>\n<blockquote>\n<p>自签证书缺点是浏览器不认识该证书，所以会显示网站不安全，想解决此问题，就到 OA 机构签发证书，比如<a href=\"https://letsencrypt.org/\">Let's Encrypt</a></p>\n</blockquote>\n<h2 id=\"nginx-的安全配置\" style=\"position:relative;\"><a href=\"#nginx-%E7%9A%84%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE\" aria-label=\"nginx 的安全配置 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nginx 的安全配置</h2>\n<blockquote>\n<p>参考:<a href=\"https://gist.github.com/plentz/6737338\">最安全的 nginx 配置</a>\n在 http 或者 server 模块添加就可</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token comment\"># 防止BEAST攻击</span>\n<span class=\"token keyword\">ssl_prefer_server_ciphers</span> on<span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 开启HSTS(HTTP Strict Transport Security)，强制https跳转</span>\n<span class=\"token keyword\">add_header</span> Strict<span class=\"token operator\">-</span>Transport<span class=\"token operator\">-</span>Security <span class=\"token string\">\"max-age=31536000; includeSubdomains; preload\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 不要在错误页面和服务器头中发送nginx版本号</span>\n<span class=\"token keyword\">server_tokens</span> off<span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 不允许浏览器在框架或iframe中呈现页面，防止点击劫持</span>\n<span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Frame<span class=\"token operator\">-</span>Options SAMEORIGIN<span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 防止content-type嗅探</span>\n<span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>Content<span class=\"token operator\">-</span>Type<span class=\"token operator\">-</span>Options nosniff<span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># xss过滤</span>\n<span class=\"token keyword\">add_header</span> X<span class=\"token operator\">-</span>XSS<span class=\"token operator\">-</span>Protection <span class=\"token string\">\"1; mode=block\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\"># 内容安全策略CSP</span>\n<span class=\"token keyword\">add_header</span> Content<span class=\"token operator\">-</span>Security<span class=\"token operator\">-</span>Policy <span class=\"token string\">\"default-src 'self';\"</span><span class=\"token punctuation\">;</span></code></pre></div>"},"primaryTag":{"name":"DevOps","color":null}},"pageContext":{"postId":"fb135f83-6ea6-5248-9831-1834eca0b945","primaryTag":"DevOps"}},"staticQueryHashes":["1116962356","2275848304","3097946992","3138592700","3462520645"]}