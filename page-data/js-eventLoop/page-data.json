{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/js-eventLoop","result":{"data":{"post":{"id":"179cb99a-e665-5def-8a8b-1cdd4ae9bca1","headings":[{"depth":2},{"depth":2},{"depth":2},{"depth":2},{"depth":2},{"depth":2},{"depth":2}],"frontmatter":{"title":"通过伪代码彻底理解事件循环","path":"/js-eventLoop","tags":["JavaScript"],"excerpt":"通过伪代码的形式讲解浏览器、Nodejs、Web Worker的事件循环机制","created":"2023-02-15 14:39","createdPretty":"15 February, 2023","updated":"2023-02-15 14:39","updatedPretty":"15 February, 2023","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACfUlEQVQozx2S20/acBiG+3ftere73i6WzBkMCkiB0nM5tKX0QAGnYBB1bmoGTrcZYmTRHTQSM+dhQ6eDbAOZcmwLVVmyy/3mzZf34n3zXTwP5AlpMNe2+ZrDdN3ub3pCbZhtgWxj6iC7uM4w3bD726h45eZBreXidBevjzANmNMgWu0y0S6p9ryi6WR1mDMw2UQlc/Q206qBSYYF+2nxFKjotd1fD8YvPXzNSjXR8CXkDLbdIQ0R6phQQoWKK1C24icO5szNlmB/yeprw2J/hKncucv5Yxe5/FHxuDz37JUvvP3YvQehkiZP9fnYbjLxJBpPLiy+CAT4TCY7MR6LJjKJ6OH6QlGIVe89XFnbqH4/O9zfP1h5mZ2bXbB4DyBM6pHqX0oqc2KWZufjyTWUmVUn3gaEJS5eSMeOjVxueer0EdEontRubq6+fimu5daXM1kntQk5iI8OcstKnSKBHbdvC6Z3MW7Pjr9XlAm/X0WIsRAXV/ggTYcLhc9/+tfT0zNvVl4/fzozhGxDHmZ1LDK+lJ4Mi6mgMOVjpyJqatQTX5wcHAsPsOTAfGIwKd9niQes/KFa0/Lr+XQqjTCrmNyFPKLJKs2dxb1C9gDhOzY/YHMOrgUrw8GqM/gbFX4R0vkw/ZtSLk6+nfZvupsbeVwoungTGqEbQ2TTQjZJrgqzTRffQUUDl3RM7jGxni8OEPYQwfBKJhOpvNv+8elQPypW1FQJ5g0IETRc1qmIQagmHe0REQBWRyUdV3RU/O8PUIVUAPOWO9Rxsp1BrA6zNZsPGNWCiEgXDAhF94Y7t1UNFXVcNkCwB8BAA4VbBVtkxACfHIEWFTVxxQAK/gPFwZujrLWvgAAAAABJRU5ErkJggg==","aspectRatio":1.7699115044247788,"src":"/static/ba12735205a4eda2d4af67a2139b42f5/90823/header.png","srcSet":"/static/ba12735205a4eda2d4af67a2139b42f5/dc47e/header.png 200w,\n/static/ba12735205a4eda2d4af67a2139b42f5/9f2d5/header.png 400w,\n/static/ba12735205a4eda2d4af67a2139b42f5/90823/header.png 800w,\n/static/ba12735205a4eda2d4af67a2139b42f5/77647/header.png 1200w,\n/static/ba12735205a4eda2d4af67a2139b42f5/f8d4f/header.png 1600w,\n/static/ba12735205a4eda2d4af67a2139b42f5/29a4f/header.png 3024w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"前言\" style=\"position:relative;\"><a href=\"#%E5%89%8D%E8%A8%80\" aria-label=\"前言 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>前言</h2>\n<p>学习了本文内容后，你将更好的理解以下内容：</p>\n<ol>\n<li>宏任务和微任务有哪些</li>\n<li>一帧中浏览器的工作流程</li>\n<li>浏览器的事件循环机制</li>\n<li>Nodejs 的事件循环机制</li>\n<li>Web Worker 的事件循环机制</li>\n<li>Nodejs 和浏览器的事件循环差异</li>\n</ol>\n<blockquote>\n<p>本文默认你已知道<code class=\"language-text\">进程</code>和<code class=\"language-text\">线程</code>的概念，并且知道浏览器内核中的五个工作线程：<code class=\"language-text\">GUI渲染线程</code>、<code class=\"language-text\">JS引擎线程</code>、<code class=\"language-text\">定时器触发线程</code>、<code class=\"language-text\">事件触发线程</code>、<code class=\"language-text\">异步http请求线程</code>的工作内容。</p>\n</blockquote>\n<h2 id=\"宏任务和微任务\" style=\"position:relative;\"><a href=\"#%E5%AE%8F%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%BE%AE%E4%BB%BB%E5%8A%A1\" aria-label=\"宏任务和微任务 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>宏任务和微任务</h2>\n<ul>\n<li>宏任务：script(整体代码)、setTimeout、setInterval、I/O、UI 事件交互、setImmediate(Nodejs 环境)</li>\n<li>微任务：Promise.then、MutationObserver、process.nextTick(Nodejs 环境)</li>\n</ul>\n<h2 id=\"一帧中对于-fps-为-60hz-的显示器来说就是-166ms浏览器的工作流程\" style=\"position:relative;\"><a href=\"#%E4%B8%80%E5%B8%A7%E4%B8%AD%E5%AF%B9%E4%BA%8E-fps-%E4%B8%BA-60hz-%E7%9A%84%E6%98%BE%E7%A4%BA%E5%99%A8%E6%9D%A5%E8%AF%B4%E5%B0%B1%E6%98%AF-166ms%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B\" aria-label=\"一帧中对于 fps 为 60hz 的显示器来说就是 166ms浏览器的工作流程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一帧中(对于 FPS 为 60HZ 的显示器来说就是 16.6ms)浏览器的工作流程</h2>\n<ol>\n<li>输入事件（如：阻塞-touch、非阻塞-click），并将回调添加到事件循环队列</li>\n<li>处理 JS 定时器，并将回调添加到事件循环队列</li>\n<li>处理开始帧对应的事件(如：window.resize、scroll)</li>\n<li>执行 rAF 回调(请求动画渲染) requestAnimationFrame</li>\n<li>页面布局（样式计算、更新布局）</li>\n<li>样式绘制</li>\n<li>如果以上六个高优先级的阶段执行完则进入该阶段（空闲阶段）requestIdleCallback</li>\n</ol>\n<blockquote>\n<p>requestIdleCallback 执行超出时间剩余时间的函数会导致浏览器卡住。而 requestAnimationFrame 会自动调节频率，如果 callback 工作太多无法在一帧内完成会自动降低为 30fps。虽然降低了，但总比掉帧好。</p>\n</blockquote>\n<h2 id=\"浏览器的事件循环机制\" style=\"position:relative;\"><a href=\"#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6\" aria-label=\"浏览器的事件循环机制 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>浏览器的事件循环机制</h2>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/*\n 浏览器的事件循环相当于一个无限循环的旋转木马一样\n*/</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  queue <span class=\"token operator\">=</span> <span class=\"token function\">getNextQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 获取下一个任务队列</span>\n  task <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//取出任务队列中的第一个任务</span>\n  <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 执行当前任务</span>\n\n  <span class=\"token comment\">// 当微任务队列有任务时，全部执行</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>microtaskQueue<span class=\"token punctuation\">.</span><span class=\"token function\">hasTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">doMicrotask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 准备开始重绘</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRepaintingTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    animationTasks <span class=\"token operator\">=</span> animationQueue<span class=\"token punctuation\">.</span><span class=\"token function\">copyTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 复制所有的动画队列中的任务</span>\n    <span class=\"token comment\">// 遍历动画队列并依次执行</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>task <span class=\"token keyword\">in</span> animationTasks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">doAnimationTask</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">repaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 重绘</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>微任务队列和动画队列（由 requestAnimationFrame 产生的回调队列）都会在单次循环中全部执行完</li>\n<li>微任务队列在运行时递归自身进入会死循环，导致页面卡死</li>\n<li>动画队列在运行时递归自身不会进入死循环，不会卡死页面。因为他是根据系统来决定回调函数的执行时机的，</li>\n</ul>\n<h2 id=\"nodejs-的事件循环\" style=\"position:relative;\"><a href=\"#nodejs-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF\" aria-label=\"nodejs 的事件循环 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nodejs 的事件循环</h2>\n<p>Nodejs 可比浏览器的事件循环简单多了，有以下原因：</p>\n<ol>\n<li>没有脚本解析事件：你不需要再 HTML 中去挑选出 JavaScript，你只需要给它一个 JavaScript 文件然后运行它即可</li>\n<li>没有讨厌的用户交互</li>\n<li>没有动画队列的回调</li>\n</ol>\n<p>Nodejs 有三个主要阶段(从上往下顺序执行)：</p>\n<ol>\n<li>timer 计时器阶段，负责执行<code class=\"language-text\">setTimeout</code>和<code class=\"language-text\">setInterval</code>回调</li>\n<li>poll 轮训阶段，用于执行所有 I/O 事件的回调，比如 定时回调、XHR 请求、磁盘读取、磁盘写入以及其他内容</li>\n<li>check 检查阶段，通过<code class=\"language-text\">setImmediate</code>添加，<code class=\"language-text\">setImmediate(cb)</code>会先于<code class=\"language-text\">setTimeout(cb,0)</code>执行</li>\n</ol>\n<blockquote>\n<p>poll 阶段比较特殊和重要：</p>\n<ul>\n<li>如果队列不为空，会遍历队列并同步执行，知道队列为空或达到系统限制</li>\n<li>\n<p>如果队列为空，会有三件事发生：</p>\n<ol>\n<li>如果有 setImmediate 回调需要执行，poll 阶段会立即停止并进入 check 阶段执行回调</li>\n<li>如果没有 setImmediate 回调需要执行，会等到回调呗加入的到队列中并立即执行，这里会有超时时间设置防止一直等待下去</li>\n<li>如果没有 setImmediate 回调并且没有其他事件回调需要执行时，当 timer 到期了，需要回到 timer 阶段执行回调</li>\n</ol>\n</li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/*\n Nodejs事件循环相当于一个等待循环的过山车一样\n*/</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token function\">tasksAreWaiting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  queue <span class=\"token operator\">=</span> <span class=\"token function\">getNextQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 每一次事件循环都会获取下一个任务队列</span>\n\n  <span class=\"token comment\">// 当前阶段有任务时，全部执行</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">hasTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    task <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 取出任务队列中的第一个任务</span>\n    <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 执行当前任务</span>\n\n    <span class=\"token comment\">// 当process.nextTick队列有任务时，全部执行</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextTickQueue<span class=\"token punctuation\">.</span><span class=\"token function\">hashTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">doNextTickTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 当promise队列有任务时，全部执行</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>promiseQueue<span class=\"token punctuation\">.</span><span class=\"token function\">hashTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">doPromiseTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"web-worker-的事件循环\" style=\"position:relative;\"><a href=\"#web-worker-%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF\" aria-label=\"web worker 的事件循环 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Web Worker 的事件循环</h2>\n<p>每个 Web Worker 都在自己的线程中工作，它有自己的堆栈，队列,一切都自己运行，它比 Nodejs 事件循环机制更加简单</p>\n<ol>\n<li>没有 script 标签</li>\n<li>没有用户交互</li>\n<li>没有 DOM 操作，所以不用关心动画、帧或者类似的东西</li>\n<li>没有 Nodejs 中的<code class=\"language-text\">setImmediate</code>和<code class=\"language-text\">nextTick</code></li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/*\n 其和浏览器的事件循环相似，只是任务队列中少了很多事件和动画\n*/</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  queue <span class=\"token operator\">=</span> <span class=\"token function\">getNextQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 获取下一个任务队列</span>\n  task <span class=\"token operator\">=</span> queue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//取出任务队列中的第一个任务</span>\n  <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 执行当前任务</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>microtaskQueue<span class=\"token punctuation\">.</span><span class=\"token function\">hasTasks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 当微任务队列有任务时，全部执行</span>\n    <span class=\"token function\">doMicrotask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isRepaintingTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">repaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 重绘</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"nodejs-和浏览器的事件循环差异\" style=\"position:relative;\"><a href=\"#nodejs-%E5%92%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%B7%AE%E5%BC%82\" aria-label=\"nodejs 和浏览器的事件循环差异 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nodejs 和浏览器的事件循环差异</h2>\n<ul>\n<li>浏览器环境下，微任务队列是每个宏任务执行完之后再执行</li>\n<li>Nodejs 环境下，微任务队列会在事件循环的各个阶段执行，在 Nodejs11 之前，需要执行完每个阶段中的所有宏任务才会执行微任务队列，但 Nodejs11 后与浏览器一致，当每个阶段执行完一个宏任务后，就执行微任务队列。</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1051px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8b2049e7cb15f23a57bb24adc2115013/58fee/diff.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWklEQVQY00WRTU/CQBCG+/s968nEmybGi0ZiFBCLtBDRCEiA0lJKKW0p9JN+sbuzWxsI+h5mkkmeZJ4ZjhX/YYzRU4ACUFoOEYLajD1KwGsFSiMS6CQwIFjS2OH+uLK4mmXyw7U4sYXJRpTMzjhLE0JofUYr430JRxs9VZqpKqL5Ozb7nJcdUAplS8LQUrTYcSNrs7PdyPEBCCa0qdHncdZasmitpVI1k9+QUifGF1eRCGwk3DqDyT3tXsDwho6ui+/zQucPK1GMobVgNQWLyyK01GTykkwbuVzDxien+qyAHPmGu1Kxb+LARp6JtjrNwqNP6fyqsqfSec52ziJX+EwVkNokZo872nqrrVEfrIWpLcpOZ2Z2lF0UH69RwlWFPoxwQy9if4UWbWR0QW9Te8CxA5xbtnt55d3euULbbQrhSILTCwDYImDyej//kJAoxMMft98LbTNN4l8sc3176CK80AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"事件循环的差异\"\n        title=\"事件循环的差异\"\n        src=\"/static/8b2049e7cb15f23a57bb24adc2115013/58fee/diff.png\"\n        srcset=\"/static/8b2049e7cb15f23a57bb24adc2115013/5a46d/diff.png 300w,\n/static/8b2049e7cb15f23a57bb24adc2115013/0a47e/diff.png 600w,\n/static/8b2049e7cb15f23a57bb24adc2115013/58fee/diff.png 1051w\"\n        sizes=\"(max-width: 1051px) 100vw, 1051px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>接下来以一个例子看清楚他们的区别</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timer1\"</span><span class=\"token punctuation\">)</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise1\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timer2\"</span><span class=\"token punctuation\">)</span>\n  Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise2\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>在浏览器和 Node11 及之后版本中会打印出：timer1 -> promise1 -> timer2 -> promise2</li>\n<li>在 Nodejs11 之前会打印出：(如果 timer1 和 timer2 都在 timer 阶段中)timer1 -> timer2 -> promise1 -> promise2，如果 timer2 还没到期则和浏览器一致。</li>\n</ul>"},"primaryTag":{"name":"JavaScript","color":"#1e81b0"}},"pageContext":{"postId":"179cb99a-e665-5def-8a8b-1cdd4ae9bca1","primaryTag":"JavaScript"}},"staticQueryHashes":["1116962356","2275848304","3097946992","3138592700","3462520645"]}