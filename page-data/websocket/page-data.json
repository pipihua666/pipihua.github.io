{"componentChunkName":"component---src-templates-blog-post-js","path":"/websocket/","result":{"data":{"site":{"siteMetadata":{"title":"皮皮花的博客"}},"markdownRemark":{"id":"a8fae49c-dbe7-5324-9d13-ebcdae487167","excerpt":"浏览器自带的 api：（如果是 https 则采用 wss）  开发环境配置：  生产环境配置： 我的 nginx 配置： 扩展：\nnodejs 后端非常好用的 websocket 通信包：https://socket.io/基于 socket.io 衍生出的前端 websocket 通信工具：https…","html":"<h4>浏览器自带的 api：（如果是 https 则采用 wss）</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 这里的转发标识为/ws</span>\n<span class=\"token keyword\">const</span> wsPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">ws://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>host<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/ws/system</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> socket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocket</span><span class=\"token punctuation\">(</span>wsPath<span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// send可以传递字符串或者二进制</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> page<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleMessage<span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"close\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleMessage<span class=\"token punctuation\">)</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><a name=\"0BRMq\"></a></p>\n<h4>开发环境配置：</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">devServer<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      proxy<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 普通http请求</span>\n        <span class=\"token string\">'/api'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:8099/'</span><span class=\"token punctuation\">,</span>\n            changeOrigin<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            secure<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// websocket请求配置</span>\n        <span class=\"token string\">'/ws'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          target<span class=\"token operator\">:</span> <span class=\"token string\">'ws://localhost:8099/'</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// 可以写http或者ws开头</span>\n          ws<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 代理使用websokcet协议</span>\n          secure<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          changeOrigin<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br />\n<p><a name=\"UDtcL\"></a></p>\n<h4>生产环境配置：</h4>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token operator\">/</span><span class=\"token operator\">/</span> 这里是websocket相关的配置\n<span class=\"token keyword\">location</span> <span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>ws <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token number\">192.168</span><span class=\"token number\">.233</span><span class=\"token number\">.238</span><span class=\"token punctuation\">:</span><span class=\"token number\">8090</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_next_upstream</span> error <span class=\"token keyword\">timeout</span> invalid_header http_500 http_502 http_503<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_http_version</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Real<span class=\"token operator\">-</span>IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>Proto <span class=\"token keyword\">https</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">\"upgrade\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Origin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_redirect</span> off<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<br />\n<h4>我的 nginx 配置：</h4>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">location</span> <span class=\"token operator\">~</span> <span class=\"token operator\">/</span>ws<span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token operator\">/</span>ws<span class=\"token operator\">/</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>v1<span class=\"token operator\">/</span>$<span class=\"token number\">1</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>ginapp<span class=\"token operator\">-</span>service<span class=\"token punctuation\">:</span><span class=\"token number\">8686</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_http_version</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_set_header</span> Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">\"upgrade\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>扩展：<br />\nnodejs 后端非常好用的 websocket 通信包：<a href=\"https://socket.io/\">https://socket.io/</a><br />基于 socket.io 衍生出的前端 websocket 通信工具：<a href=\"https://socket.io/docs/client-api/\">https://socket.io/docs/client-api/</a><br />注意：socket.io.client 必须与 socker.io 配合使用<br />\n<br /></p>","frontmatter":{"title":"react使用websocket通信","date":"February 20, 2021","description":"react使用websocket通信"}},"previous":{"fields":{"slug":"/webpack/"},"frontmatter":{"title":"webpack中五个容易混淆的知识点"}},"next":{"fields":{"slug":"/wireshark/"},"frontmatter":{"title":"wireshark过滤器表达式"}}},"pageContext":{"id":"a8fae49c-dbe7-5324-9d13-ebcdae487167","previousPostId":"c7f2b814-523c-524a-b51b-023e40cb6ba7","nextPostId":"04d86673-ef44-5a8b-93a3-09520a295092"}},"staticQueryHashes":["2841359383","3122794013"]}