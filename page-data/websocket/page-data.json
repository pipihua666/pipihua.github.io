{"componentChunkName":"component---theme-src-templates-post-tsx","path":"/websocket","result":{"data":{"post":{"id":"b0e210c9-c4f7-509f-a05b-d2adca87d8f6","headings":[{"depth":2},{"depth":2},{"depth":2},{"depth":2},{"depth":2}],"frontmatter":{"title":"react使用websocket通信","path":"/websocket","tags":["Network"],"excerpt":"react使用websocket通信","created":"2021-02-20 21:45","createdPretty":"20 February, 2021","updated":"2021-04-11T00:00:00.000Z","updatedPretty":"11 April, 2021","featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAC4jAAAuIwF4pT92AAADEklEQVQozw2N7VMSCQCH97+4qTsrShBXFpZlgX3fhWWBXRAEEdB0PCBJSRIMLzMyhG6sAJVSeQ0zo5LLzrzJ3mYub7KppvrQf3R8eGZ+X57fA+gpAsNQBO6jDGoGhzG012FCFia8/2xmv+83fr7a/nGw9eNl89v+1tcXzS97D47b9Q9PKgfVlWx8HOjtkcGQHIWVGtU5GJIN2rDlZKiRu/K2fufL8+r3l1udi89/1Y7btU/t+sfd2n/Pah9alfZqNteRYVW3sueMQv4bBHb5JDJ/NVb9c/719vpRu378vHn0uPR+5/7x3sPO/vdJpdM8elp7t7N52FjNJSKATHZCIf9V03dK4tHrsdH8fKy1cnO/VjhsFouzgfmAYXlCqKdDe/cyb1u1N4+rh9sbrx+VDxprN6bHAaX8pBrssrKa6IgjlwiVl2aflbIvNpczUbcHO+3EZcMmxaSonHb23Zly7Fdu//1gY7e8tlO6m03FAUQtk3gk5BcS4cF0bLi4MHV/MV7PpfwcNMaTETtNQ7+I+tNhN5f0YsX40G7lXmu9sF3Kr2TSAIv32ggwMeJeiAbi4eDtazP59OzSYtbrcvXj2qid8bDw1eSVfH59Y22jWii2yuXmamElc31xNg5YJBuhBVkdxOM6n394MpaMRKcvz90cDU3ByrMY2DXiHQyHYpELM5HYXO5WsVFubhZXi7dyufQNANQoFSrFWVAhV3WDiLbf1S9YBa8vGBge10AgS+IBX1DkzW7R4Rsa9YxNTqQyhVLtUvIPI28BUExjJHQ4rjKQCEdDJI1SpMblksYnZhzOAY9ot3MUR5MMw9AWK+XwiGOTF1JL84vLTqcDMBrVar2GNPZoMa2JkOuMkF4vFy1oOHo5HLrotNlYCufMfAeU4TCLjR3wu0LT0bml1Nw1ANUp1VolS6sxGpNEDtaeIyidxy04XQOS6GBIHDeiBInrCQIhKT3DGcwCKbntgd/PRxMAolVAULfZZDBbOKfEWwWKFzh/cEiwWewWFkMhjiZYjqVMpk5cz7AIQSEUjQmi1Rv8H1OrJKaXHwWoAAAAAElFTkSuQmCC","aspectRatio":1.5037593984962405,"src":"/static/dc6da965afbecc04f53ba4eeafaf5c6b/90823/girl.png","srcSet":"/static/dc6da965afbecc04f53ba4eeafaf5c6b/dc47e/girl.png 200w,\n/static/dc6da965afbecc04f53ba4eeafaf5c6b/9f2d5/girl.png 400w,\n/static/dc6da965afbecc04f53ba4eeafaf5c6b/90823/girl.png 800w,\n/static/dc6da965afbecc04f53ba4eeafaf5c6b/77647/girl.png 1200w,\n/static/dc6da965afbecc04f53ba4eeafaf5c6b/f8d4f/girl.png 1600w,\n/static/dc6da965afbecc04f53ba4eeafaf5c6b/4ce6a/girl.png 1920w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"html":"<h2 id=\"浏览器自带的-api\" style=\"position:relative;\"><a href=\"#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%87%AA%E5%B8%A6%E7%9A%84-api\" aria-label=\"浏览器自带的 api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>浏览器自带的 api</h2>\n<blockquote>\n<p>如果是 https 则采用 wss</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 这里的转发标识为/ws</span>\n<span class=\"token keyword\">const</span> wsPath <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">ws://</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>host<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/ws/system</span><span class=\"token template-punctuation string\">`</span></span>\n<span class=\"token keyword\">const</span> socket <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WebSocket</span><span class=\"token punctuation\">(</span>wsPath<span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"open\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// send可以传递字符串或者二进制</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> page<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">:</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleMessage<span class=\"token punctuation\">)</span>\nsocket<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"close\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleMessage<span class=\"token punctuation\">)</span>\n  socket<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><a name=\"0BRMq\"></a></p>\n<h2 id=\"开发环境配置：\" style=\"position:relative;\"><a href=\"#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%9A\" aria-label=\"开发环境配置： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>开发环境配置：</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">devServer<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      proxy<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 普通http请求</span>\n        <span class=\"token string\">'/api'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            target<span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:8099/'</span><span class=\"token punctuation\">,</span>\n            changeOrigin<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            secure<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// websocket请求配置</span>\n        <span class=\"token string\">'/ws'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          target<span class=\"token operator\">:</span> <span class=\"token string\">'ws://localhost:8099/'</span><span class=\"token punctuation\">,</span><span class=\"token comment\">// 可以写http或者ws开头</span>\n          ws<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 代理使用websokcet协议</span>\n          secure<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          changeOrigin<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<br />\n<p><a name=\"UDtcL\"></a></p>\n<h2 id=\"生产环境配置：\" style=\"position:relative;\"><a href=\"#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%9A\" aria-label=\"生产环境配置： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生产环境配置：</h2>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token operator\">/</span><span class=\"token operator\">/</span> 这里是websocket相关的配置\n<span class=\"token keyword\">location</span> <span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>ws <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span><span class=\"token number\">192.168</span><span class=\"token number\">.233</span><span class=\"token number\">.238</span><span class=\"token punctuation\">:</span><span class=\"token number\">8090</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_next_upstream</span> error <span class=\"token keyword\">timeout</span> invalid_header http_500 http_502 http_503<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_http_version</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Real<span class=\"token operator\">-</span>IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> X<span class=\"token operator\">-</span>Forwarded<span class=\"token operator\">-</span>Proto <span class=\"token keyword\">https</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">\"upgrade\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_set_header</span> Origin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">proxy_redirect</span> off<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>\n<br />\n<h2 id=\"我的-nginx-配置：\" style=\"position:relative;\"><a href=\"#%E6%88%91%E7%9A%84-nginx-%E9%85%8D%E7%BD%AE%EF%BC%9A\" aria-label=\"我的 nginx 配置： permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>我的 nginx 配置：</h2>\n<div class=\"gatsby-highlight\" data-language=\"nginx\"><pre class=\"language-nginx\"><code class=\"language-nginx\"><span class=\"token keyword\">location</span> <span class=\"token operator\">~</span> <span class=\"token operator\">/</span>ws<span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token operator\">/</span>ws<span class=\"token operator\">/</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span>api<span class=\"token operator\">/</span>v1<span class=\"token operator\">/</span>$<span class=\"token number\">1</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_pass</span> <span class=\"token keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>ginapp<span class=\"token operator\">-</span>service<span class=\"token punctuation\">:</span><span class=\"token number\">8686</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_http_version</span> <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_set_header</span> Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">proxy_set_header</span> Connection <span class=\"token string\">\"upgrade\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"参考\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考</h2>\n<ul>\n<li>nodejs 后端非常好用的 websocket 通信包：<a href=\"https://socket.io/\">https://socket.io/</a></li>\n<li>基于 socket.io 衍生出的前端 websocket 通信工具：<a href=\"https://socket.io/docs/client-api/\">https://socket.io/docs/client-api/</a></li>\n<li>注意：socket.io.client 必须与 socker.io 配合使用</li>\n</ul>"},"primaryTag":{"name":"Network","color":null}},"pageContext":{"postId":"b0e210c9-c4f7-509f-a05b-d2adca87d8f6","primaryTag":"Network"}},"staticQueryHashes":["1116962356","2275848304","3138592700","3462520645","545095672"]}